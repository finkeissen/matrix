{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.invalid/matrix/system/schema/v1/run-manifest.schema.json",
  "title": "run manifest (v1)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "run_id",
    "run_type",
    "created_at",
    "created_by",
    "inputs",
    "outputs",
    "validation"
  ],
  "properties": {
    "run_id": {
      "type": "string",
      "minLength": 1
    },
    "run_type": {
      "type": "string",
      "enum": [
        "R_ingest",
        "R_construct",
        "R_compare",
        "R_transform",
        "R_validate",
        "R_reflexive",
        "R_stop"
      ]
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "created_by": {
      "type": "string",
      "minLength": 1,
      "description": "Human or system identifier."
    },

    "research_program_commit": { "type": "string" },
    "mms_commit": { "type": "string" },
    "matrix_commit": { "type": "string" },

    "inputs": {
      "type": "array",
      "items": { "$ref": "#/$defs/io_ref" },
      "default": []
    },
    "outputs": {
      "type": "array",
      "items": { "$ref": "#/$defs/io_ref" },
      "default": []
    },

    "parameters": {
      "type": "object",
      "description": "Run parameters (non-authoritative).",
      "additionalProperties": true,
      "default": {}
    },

    "tooling": {
      "description": "Optional tooling metadata; required when external tools/LLMs are used.",
      "oneOf": [
        { "type": "null" },
        { "$ref": "#/$defs/tooling" }
      ],
      "default": null
    },

    "non_determinism": {
      "description": "Explicit statement of nondeterminism sources (if any).",
      "oneOf": [
        { "type": "null" },
        { "$ref": "#/$defs/non_determinism" }
      ],
      "default": null
    },

    "notes": {
      "type": "string",
      "description": "Free text; must not introduce implicit authority.",
      "default": ""
    },

    "validation": {
      "$ref": "#/$defs/validation"
    }
  },

  "$defs": {
    "artifact_type_v1": {
      "type": "string",
      "enum": [
        "problem",
        "claim",
        "relation",
        "conflict",
        "source",
        "observation",
        "stop_record"
      ]
    },

    "io_kind": {
      "type": "string",
      "enum": [
        "artifact_jsonl",
        "snapshot",
        "export",
        "log",
        "report",
        "other"
      ]
    },

    "io_ref": {
      "title": "input/output reference",
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "path"],
      "properties": {
        "kind": { "$ref": "#/$defs/io_kind" },

        "path": { "type": "string", "minLength": 1 },
        "format": { "type": "string", "default": "jsonl" },

        "domain": {
          "type": "string",
          "description": "Optional domain identifier for domain-bound I/O."
        },

        "artifact_types": {
          "type": "array",
          "items": { "$ref": "#/$defs/artifact_type_v1" },
          "minItems": 1,
          "description": "What artifact types are contained in this file (if applicable)."
        },

        "counts": {
          "type": "object",
          "description": "Optional per-type counts for auditability.",
          "additionalProperties": {
            "type": "integer",
            "minimum": 0
          }
        },

        "hash": {
          "type": "string",
          "description": "Optional content hash for auditability."
        },

        "notes": {
          "type": "string",
          "description": "Optional; must not change meaning."
        }
      }
    },

    "tooling": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tools"],
      "properties": {
        "tools": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/tool" }
        }
      }
    },

    "tool": {
      "type": "object",
      "additionalProperties": true,
      "required": ["name"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "version": { "type": "string" },
        "provider": { "type": "string" },
        "params": { "type": "object", "additionalProperties": true }
      }
    },

    "non_determinism": {
      "type": "object",
      "additionalProperties": false,
      "required": ["present"],
      "properties": {
        "present": { "type": "boolean" },
        "sources": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["llm_sampling", "external_state", "random_seed", "tool_variance", "human_input", "unknown"]
          },
          "default": []
        },
        "notes": { "type": "string", "default": "" }
      }
    },

    "validation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["schema", "policy"],
      "properties": {
        "schema": { "$ref": "#/$defs/validation_result" },
        "policy": { "$ref": "#/$defs/validation_result" }
      }
    },

    "validation_result": {
      "type": "object",
      "additionalProperties": false,
      "required": ["status"],
      "properties": {
        "status": { "type": "string", "enum": ["passed", "failed", "skipped"] },
        "messages": { "type": "array", "items": { "type": "string" }, "default": [] }
      }
    }
  }
}

